<% layout('layouts/boilerplate') %>

<!-- Premium Font -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

<div class="container-fluid py-5 bg-light min-vh-100">

  <!-- Header -->
  <div class="px-5 py-5 bg-dark text-white text-center shadow-sm">
    <h1 class="mb-3"
      style="font-family: 'Playfair Display', serif; font-weight: 700; font-size: 3rem; letter-spacing: 1px;">
      <i class="fa-solid fa-wand-magic-sparkles text-warning me-3"></i>
      <%= decor.name %>
    </h1>
    <p class="mb-0 text-light opacity-75 fs-5">
      Transform your event with stunning décor excellence.
    </p>
  </div>

  <!-- Page Grid -->
  <div class="row g-0 mt-4 px-4">

    <!-- LEFT CONTENT -->
    <div class="col-lg-8 col-md-7 p-4">

      <!-- Image -->
      <div class="mb-4">
        <% if (decor.imageUrl) { %>
          <img src="<%= decor.imageUrl %>" alt="<%= decor.name %>" class="w-100 rounded-3 shadow"
               style="height: 500px; object-fit: cover;">
        <% } else { %>
          <img src="https://via.placeholder.com/1200x500?text=No+Image+Available"
               class="w-100 rounded-3 shadow">
        <% } %>
      </div>

      <!-- Decor Details -->
      <p class="text-muted mb-3 fs-5">
        <i class="fa-solid fa-location-dot text-danger me-2"></i>
        <%= decor.city %> <% if (decor.state) { %>(<%= decor.state %>)<% } %>
      </p>

      <p class="text-muted fs-6 mb-2">
        <i class="fa-solid fa-palette text-primary me-2"></i>
        Style: <strong><%= decor.style %></strong>
      </p>

      <p class="text-muted fs-6 mb-2">
        <i class="fa-solid fa-briefcase text-warning me-2"></i>
        Services Offered:
        <strong>
          <%= decor.servicesOffered?.length ? decor.servicesOffered.join(', ') : 'Not specified' %>
        </strong>
      </p>

      <p class="fw-semibold text-success fs-5 mb-3">
        <i class="fa-solid fa-indian-rupee-sign me-1"></i>
        <%= decor.priceRange?.min || 0 %> - <%= decor.priceRange?.max || 0 %>
      </p>

      <!-- Contact Info -->
      <div class="mb-4">
        <% if (decor.contactNumber) { %>
          <p class="mb-1 text-muted fs-6">
            <i class="fa-solid fa-phone text-success me-2"></i>
            <%= decor.contactNumber %>
          </p>
        <% } %>

        <% if (decor.email) { %>
          <p class="mb-1 text-muted fs-6">
            <i class="fa-solid fa-envelope text-primary me-2"></i>
            <%= decor.email %>
          </p>
        <% } %>
      </div>

      <p class="small text-muted mt-4">
        <i class="fa-solid fa-calendar-days me-1"></i>
        Added on: <%= new Date(decor.createdAt).toLocaleDateString() %>
      </p>

      <div class="mt-4">
        <a href="/decors" class="btn btn-outline-secondary px-4">
          <i class="fa-solid fa-arrow-left me-2"></i>Back
        </a>
      </div>

      <!-- ⭐⭐⭐⭐⭐ RATING SECTION -->
      <hr class="my-5">

      <div id="reviews">
        <h3 class="fw-bold mb-3">Customer Reviews & Ratings</h3>

        <!-- Average Rating -->
        <div class="mb-3">
          <% if (totalReviews > 0) { %>
            <h5 class="mb-1">⭐ <%= avgRating %> / 5</h5>
            <p class="text-muted small"><%= totalReviews %> reviews</p>
          <% } else { %>
            <p class="text-muted small">No reviews yet. Be the first to rate!</p>
          <% } %>
        </div>

        <!-- Rating Form -->
        <form action="/decors/<%= decor._id %>/rate" method="POST" class="mb-4">

          <div class="mb-2">
            <label class="form-label fw-semibold">Your Name</label>
            <input type="text" name="userName" class="form-control" required>
          </div>

          <!-- Clickable Stars -->
          <div class="mb-2">
            <label class="form-label fw-semibold">Your Rating</label>
            <div class="star-rating">
              <input type="hidden" name="stars" id="starsInput" value="0">

              <% for (let s = 1; s <= 5; s++) { %>
                <span class="star" data-val="<%= s %>">&#9733;</span>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Comment</label>
            <textarea name="comment" class="form-control" rows="3"></textarea>
          </div>

          <button class="btn btn-primary">Submit Review</button>
        </form>

        <!-- Reviews List -->
        <% ratings.forEach(r => { %>
          <div class="border p-3 mb-3 rounded bg-white shadow-sm">
            <div class="d-flex justify-content-between">
              <h6 class="fw-bold m-0"><%= r.userName %></h6>
              <small class="text-muted"><%= new Date(r.createdAt).toLocaleDateString() %></small>
            </div>

            <p class="text-warning mb-1">
              <% for (let i = 1; i <= 5; i++) { %>
                <% if (i <= r.stars) { %>
                  <i class="fa-solid fa-star"></i>
                <% } else { %>
                  <i class="fa-regular fa-star"></i>
                <% } %>
              <% } %>
            </p>

            <p class="text-muted small mb-2"><%= r.comment || "No comment provided." %></p>

            <form action="/decors/<%= decor._id %>/rate/<%= r._id %>?_method=DELETE" method="POST"
                  onsubmit="return confirm('Delete this review?')">
              <button class="btn btn-sm btn-outline-danger">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </form>
          </div>
        <% }) %>
      </div>

    </div>

    <!-- RIGHT STICKY -->
    <div class="col-lg-4 col-md-5 bg-white border-start p-5 shadow-sm">
      <div class="sticky-top" style="top: 5rem;">

        <!-- Rating Display -->
        <div class="text-center mb-5">
          <h4 class="fw-bold text-dark mb-2">Overall Rating</h4>
          <h2 class="text-warning"><%= avgRating %> ⭐</h2>
          <p class="text-muted small">Based on <%= totalReviews %> reviews</p>
        </div>

        <!-- Booking -->
        <form action="/decors/<%= decor._id %>/book" method="POST">
          <button class="btn btn-success btn-lg px-5 shadow w-100">
            <i class="fa-solid fa-calendar-check me-2"></i>Book This Decor
          </button>
        </form>

        <!-- Why Choose -->
        <div class="mt-4">
          <h5 class="fw-bold text-dark mb-3">Why Choose This Decor?</h5>
          <ul class="list-unstyled text-muted small">
            <li><i class="fa-solid fa-circle-check text-success me-2"></i>Creative & modern themes</li>
            <li><i class="fa-solid fa-circle-check text-success me-2"></i>High-quality décor materials</li>
            <li><i class="fa-solid fa-circle-check text-success me-2"></i>Perfect for weddings & luxury events</li>
          </ul>
        </div>

      </div>
    </div>

  </div>
</div>

<style>
.star-rating .star {
  font-size: 2rem;
  color: #ccc;
  cursor: pointer;
  transition: color 0.2s;
}
.star-rating .star.selected {
  color: gold;
}
</style>

<script>
const stars = document.querySelectorAll(".star-rating .star");
const inputStars = document.getElementById("starsInput");

stars.forEach(star => {
  star.addEventListener("click", function () {
    const value = this.dataset.val;
    inputStars.value = value;

    stars.forEach(s => s.classList.remove("selected"));
    stars.forEach(s => {
      if (s.dataset.val <= value) s.classList.add("selected");
    });
  });
});
</script>
